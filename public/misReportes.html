<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Mis Reportes</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>

</head>
<body class="bg-gray-100 p-6">
<div class="max-w-6xl mx-auto">
<div class="mb-4">
<a class="inline-block bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded" href="/menu">← Volver al Menú</a>
</div>
<h1 class="text-2xl font-bold mb-4">Mis Reportes</h1>
<div class="space-y-4" id="lista-reportes"></div>
<div class="mt-8 hidden" id="embed-container">
<h2 class="text-xl font-semibold mb-2" id="reporte-titulo"></h2>
<div class="h-[600px] border rounded" id="powerbi-container"></div>
</div>
</div>
<script>
    function esperarPowerBI() {
      return new Promise((resolve, reject) => {
        const intervalo = setInterval(() => {
          if (window.powerbi && window.powerbi.models) {
            clearInterval(intervalo);
            resolve(window.powerbi.models);
          }
        }, 100);
        setTimeout(() => {
          clearInterval(intervalo);
          reject("Power BI no se cargó a tiempo.");
        }, 5000);
      });
    }


    const username = localStorage.getItem("username");
    if (!username) {
      alert("Debes iniciar sesión");
      window.location.href = "/";
    }

    async function cargarReportes() {
      const res = await fetch("/api/asignaciones");
      const todos = await res.json();
      const propios = todos.filter(r => r.usuario === username);

      // Agrupar por grupo
      const agrupado = {};
      propios.forEach(r => {
        const grupo = r.reportes_powerbi?.grupo || "Sin grupo";
        if (!agrupado[grupo]) agrupado[grupo] = [];
        agrupado[grupo].push(r);
      });

      const contenedor = document.getElementById("lista-reportes");
      contenedor.innerHTML = "";

      Object.keys(agrupado).forEach(grupo => {
        const grupoDiv = document.createElement("div");
        grupoDiv.innerHTML = `<h3 class='text-lg font-semibold'>${grupo}</h3>`;

        agrupado[grupo].forEach(r => {
          const btn = document.createElement("button");
          btn.textContent = r.reportes_powerbi.nombre;
          btn.className = "block text-left w-full bg-white shadow px-4 py-2 rounded hover:bg-blue-50 border";
          btn.onclick = () => mostrarReporte(r.reportes_powerbi);
          grupoDiv.appendChild(btn);
        });

        contenedor.appendChild(grupoDiv);
      });
    }

    async function mostrarReporte(info) {
      const embed = document.getElementById("embed-container");
      const titulo = document.getElementById("reporte-titulo");
      const contenedor = document.getElementById("powerbi-container");
      let models;
  try {
    models = await esperarPowerBI();
  } catch (e) {
    console.error(e);
    contenedor.innerHTML = "Error al cargar Power BI.";
    return;
  }

      embed.classList.remove("hidden");
      titulo.textContent = info.nombre;
      contenedor.innerHTML = "Cargando...";

      const res = await fetch("https://nietsnie.app.n8n.cloud/webhook/generar-token-powerbi", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          groupId: info.group_id,
          reportId: info.report_id
        })
      });

      const datos = await res.json();
      contenedor.innerHTML = "";

      const embedConfig = {
        type: 'report',
        id: datos.report_id,
        embedUrl: datos.embedUrl,
        accessToken: datos.embedToken,
        tokenType: models.TokenType.Embed,
        permissions: models.Permissions.All,
        settings: {
          panes: {
            filters: { visible: false },
            pageNavigation: { visible: true }
          },
          background: models.BackgroundType.Transparent
        }
      };

      const existing = powerbi.get(contenedor);
      if (existing) powerbi.reset(contenedor);

      powerbi.embed(contenedor, embedConfig);

    }

    window.onload = cargarReportes;
  </script>
<script src="https://cdn.jsdelivr.net/npm/powerbi-client@2.19.0/dist/powerbi.js"></script></body>
</html>
